<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - ncrsh-Swarm</title>
    
    <!-- CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- D3.js for topology -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.6.1/d3.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-active { background: #10b981; }
        .status-inactive { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        
        .navbar {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar {
            background: rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(30px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-item {
            transition: all 0.3s ease;
            border-radius: 12px;
            margin: 4px 8px;
        }
        
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .sidebar-item.active {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .alert-banner {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-radius: 12px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .pulse-dot {
            animation: pulse-dot 1.5s infinite;
        }
        
        @keyframes pulse-dot {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .glow-on-hover {
            transition: all 0.3s ease;
        }
        
        .glow-on-hover:hover {
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="text-white">
    <!-- Navigation Bar -->
    <nav class="navbar fixed top-0 left-0 right-0 z-50 p-4">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-brain text-white text-sm"></i>
                    </div>
                    <h1 class="text-xl font-bold">ncrsh-Swarm</h1>
                </div>
                
                <div class="hidden md:flex items-center space-x-1">
                    <span class="status-indicator status-active pulse-dot"></span>
                    <span class="text-sm">{{ swarm_status.nodes or 0 }} nodes active</span>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- Connection Status -->
                <div class="flex items-center space-x-2 text-sm">
                    <span id="connection-status" class="status-indicator status-active"></span>
                    <span id="connection-text">Connected</span>
                </div>
                
                <!-- Alerts Badge -->
                {% if active_alerts > 0 %}
                <div class="relative">
                    <i class="fas fa-bell text-yellow-400 text-lg"></i>
                    <div class="absolute -top-2 -right-2 bg-red-500 text-xs rounded-full w-5 h-5 flex items-center justify-center">
                        {{ active_alerts }}
                    </div>
                </div>
                {% endif %}
                
                <!-- User Menu -->
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-sm"></i>
                    </div>
                    <span class="text-sm">Dashboard</span>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Layout -->
    <div class="flex pt-20">
        <!-- Sidebar -->
        <aside class="sidebar w-64 h-screen fixed left-0 p-4">
            <nav class="space-y-2">
                <a href="/" class="sidebar-item flex items-center space-x-3 p-3 text-white hover:text-blue-300 block {% if request.path == '/' %}active{% endif %}">
                    <i class="fas fa-home w-5"></i>
                    <span>Dashboard</span>
                </a>
                
                <a href="/nodes" class="sidebar-item flex items-center space-x-3 p-3 text-white hover:text-blue-300 block {% if request.path == '/nodes' %}active{% endif %}">
                    <i class="fas fa-server w-5"></i>
                    <span>Nodes</span>
                </a>
                
                <a href="/metrics" class="sidebar-item flex items-center space-x-3 p-3 text-white hover:text-blue-300 block {% if request.path == '/metrics' %}active{% endif %}">
                    <i class="fas fa-chart-line w-5"></i>
                    <span>Metrics</span>
                </a>
                
                <a href="/topology" class="sidebar-item flex items-center space-x-3 p-3 text-white hover:text-blue-300 block {% if request.path == '/topology' %}active{% endif %}">
                    <i class="fas fa-project-diagram w-5"></i>
                    <span>Topology</span>
                </a>
                
                <a href="/logs" class="sidebar-item flex items-center space-x-3 p-3 text-white hover:text-blue-300 block {% if request.path == '/logs' %}active{% endif %}">
                    <i class="fas fa-file-alt w-5"></i>
                    <span>Logs</span>
                </a>
                
                <div class="border-t border-white border-opacity-20 my-4"></div>
                
                <!-- Quick Actions -->
                <div class="space-y-2">
                    <button class="sidebar-item w-full flex items-center space-x-3 p-3 text-white hover:text-green-300 text-left" onclick="scaleSwarm()">
                        <i class="fas fa-plus w-5"></i>
                        <span>Scale Swarm</span>
                    </button>
                    
                    <button class="sidebar-item w-full flex items-center space-x-3 p-3 text-white hover:text-red-300 text-left" onclick="emergencyStop()">
                        <i class="fas fa-stop w-5"></i>
                        <span>Emergency Stop</span>
                    </button>
                </div>
            </nav>
            
            <!-- System Status -->
            <div class="mt-8 p-4 glass-effect">
                <h3 class="text-sm font-semibold mb-3">System Status</h3>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between">
                        <span>Uptime</span>
                        <span id="uptime">{{ "%.1f"|format(swarm_status.uptime or 0) }}h</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Version</span>
                        <span>{{ swarm_status.version or "0.1.0" }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Mode</span>
                        <span class="text-green-400">{{ swarm_status.status or "Active" }}</span>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="flex-1 ml-64 p-6">
            {% block content %}
            <!-- Default content will be overridden by specific pages -->
            {% endblock %}
        </main>
    </div>
    
    <!-- WebSocket Connection -->
    <script>
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                document.getElementById('connection-status').className = 'status-indicator status-active';
                document.getElementById('connection-text').textContent = 'Connected';
                reconnectAttempts = 0;
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    console.error('Failed to parse WebSocket message:', e);
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                document.getElementById('connection-status').className = 'status-indicator status-inactive';
                document.getElementById('connection-text').textContent = 'Disconnected';
                
                // Attempt to reconnect
                if (reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(() => {
                        reconnectAttempts++;
                        console.log(`Reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                        connectWebSocket();
                    }, 2000 * reconnectAttempts);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                document.getElementById('connection-status').className = 'status-indicator status-warning';
                document.getElementById('connection-text').textContent = 'Error';
            };
        }
        
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'metrics_update':
                    if (window.updateMetrics) {
                        window.updateMetrics(data.data);
                    }
                    break;
                case 'node_update':
                    if (window.updateNodes) {
                        window.updateNodes(data.data);
                    }
                    break;
                case 'alert':
                    showAlert(data.data);
                    break;
            }
        }
        
        function showAlert(alertData) {
            // Create alert notification
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-banner p-4 mb-4 text-white`;
            alertDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <div class="font-semibold">${alertData.title}</div>
                            <div class="text-sm opacity-90">${alertData.message}</div>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Add to page
            const main = document.querySelector('main');
            main.insertBefore(alertDiv, main.firstChild);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 10000);
        }
        
        // Quick action functions
        function scaleSwarm() {
            const newNodeCount = prompt('Enter target number of nodes:');
            if (newNodeCount && !isNaN(newNodeCount)) {
                fetch('/api/swarm/scale', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target_nodes: parseInt(newNodeCount) })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert({
                            title: 'Scaling Initiated',
                            message: `Scaling swarm to ${newNodeCount} nodes`
                        });
                    } else {
                        showAlert({
                            title: 'Scaling Failed',
                            message: data.message || 'Failed to scale swarm'
                        });
                    }
                })
                .catch(error => {
                    console.error('Scale request failed:', error);
                    showAlert({
                        title: 'Request Failed',
                        message: 'Failed to send scale request'
                    });
                });
            }
        }
        
        function emergencyStop() {
            if (confirm('Are you sure you want to emergency stop all nodes? This action cannot be undone.')) {
                showAlert({
                    title: 'Emergency Stop',
                    message: 'Emergency stop initiated - all nodes will shut down'
                });
            }
        }
        
        // Initialize WebSocket connection
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            
            // Update uptime every minute
            setInterval(function() {
                const uptimeElement = document.getElementById('uptime');
                if (uptimeElement) {
                    const currentUptime = parseFloat(uptimeElement.textContent);
                    uptimeElement.textContent = (currentUptime + 0.0167).toFixed(1) + 'h'; // Add 1 minute
                }
            }, 60000);
        });
    </script>
    
    {% block scripts %}
    <!-- Page-specific scripts will be added here -->
    {% endblock %}
</body>
</html>